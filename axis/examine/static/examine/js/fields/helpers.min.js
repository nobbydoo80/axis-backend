function buildRegexDirective(e){return{restrict:"A",require:"?ngModel",link:function(t,i,n,l){l&&l.$parsers.push(function(t){var i=t?t.replace(e,""):null;return i!=t&&(l.$setViewValue(i),l.$render()),i})}}}function callWhenDifferent(e){return function(t,i){t!=i&&e(t,i)}}function removeWatcherWhenAny(e,t,i){var n;n=e.$watch(t,function(e,t){_.any([e,t])&&(n(),i())})}function waitForElement(e){return function(){try{return e.$element.find(".fileinput").length||void 0}catch(e){return}}}function markFileAsExisting(e){return function(){e.$element.find(".fileinput.fileinput-new").removeClass("fileinput-new").addClass("fileinput-exists")}}angular.module("axis.fields.helpers.tab").directive("tabHelper",function(e,t,i){return{restrict:"A",compile:function(n,l){var r=l.endpoint.split(".").pop();l.$set("active","tabsActive['"+r+"'].active"),l.$set("select",'go("'+l.endpoint+'")');var o=t(l.disabled)(e);return i.addTab(l.endpoint,o),function(e,t,n){if(n.disabled)var l=e.$watch(function(){return!!e.$eval(n.disabled)},function(e,t){e!==t&&(i.updateDisableListener(n.endpoint,e),l())});e.go=i.go}}}}),angular.module("axis.fields.helpers.fileField").directive("fileFieldHelper",function(e,t,i){return{restrict:"EA",scope:!0,link:function(n,l,r){function o(e,t){var i=e.target.result,n=t.split(".").pop();return i.indexOf(":;")>-1?i=i.replace(":;",":application/"+n+";"):i.indexOf("octet-stream")>-1&&"blg"==n&&(i=i.replace("octet-stream",n)),i}function a(e,t,i,n){t.object[e.raw_key]=i,t.object[e.name_key]=n,t.fields[e.field.prefixed_name].value=n}var c=n.$eval(r.fileFieldHelper);const u=n.$eval(r.autoSave);n.raw_key=c+"_raw",n.name_key=c+"_raw_name",n.highlightDropArea=!1,n.fileProgress=null,n.field.widget.attrs.multiple&&l.attr("multiple",!0);const s=(t,l)=>{var r=e.defer(),c=t.name,s=new FileReader;return s.onload=function(e){console.groupCollapsed("file"),console.log("name",name),console.log("file",e),console.groupEnd("file");var t=o(e,c);0===l?(a(n,n.regionObject,t,c),n.$apply(),r.resolve(),u&&i.callMethod("save",n.regionObject).then(()=>i.callMethod("exit",n.regionObject))):n.regionSet.fetchNewRegion().then(function(e){n.fileProgress=null,a(n,e,t,c),removeWatcherWhenAny(n,waitForElement(e),markFileAsExisting(e)),r.resolve(),u&&i.callMethod("save",e).then(()=>i.callMethod("exit",e))})},s.readAsDataURL(t),r.promise},f=r.dropArea||"axis-field";$(l).closest(f).on("dragover dragenter",e=>{e.stopPropagation(),e.preventDefault(),n.highlightDropArea=!0},!1),$(l).closest(f).on("dragleave",e=>{e.stopPropagation(),e.preventDefault(),n.highlightDropArea=!1},!1),$(l).closest(f).on("drop",i=>{n.highlightDropArea=!1,n.fileProgress=0,i.stopPropagation(),i.preventDefault();var l=angular.forEach(i.originalEvent.dataTransfer.files,s);e.all(l).then(()=>{t(()=>console.log("Triggering $scope.$apply()"),1e3)})}),l.on("change",i=>{var n=angular.forEach(i.target.files,s);e.all(n).then(function(){t(()=>console.log("Triggering $scope.$apply()"),1e3)})})}}}),angular.module("axis.fields.helpers.select2").directive("uiSelectHelper",function(e,t,i){return{restrict:"A",require:"uiSelect",link:function(n,l,r,o){function a(){c(n.field)||i(function(){l.find("ul.select2-results").removeAttr("group-by"),n.$select.isGrouped=!1}),u(),s()}function c(e){return void 0!==e.widget.widget_id}function u(){if(n.field.value){if(angular.isArray(n.field.value))angular.forEach(n.field.value,function(e,t){var i={id:e,text:n.field.value_label[t]};n.selectOptions.push(i)});else{var e={id:n.field.value,text:n.field.value_label};n.selectOptions.push(e)}n.regionObject.object[n.field.field_name]||(n.regionObject.object[n.field.field_name]=n.field.value)}}function s(){n.field.widget.choices&&n.field.widget.choices.length&&angular.forEach(n.field.widget.choices,function(e,t,i){var l={id:e[0],text:e[1]};angular.isUndefined(_.find(n.selectOptions,l))&&n.selectOptions.push(l)})}function f(e,t){return angular.forEach(e,function(e){e.type="Select from existing:"}),e.unshift({text:n.$select.search,id:n.$select.search,type:"Create New:"}),t&&e.unshift({text:"No Results...",id:null,type:"Select from existing:"}),e}function d(e){if(e){var i={term:e,page:1,field_id:n.field.widget.widget_id};return t.get("/select2/fields/auto.json",{params:i}).then(function(e){e.data.results.length?n.selectOptions=e.data.results:n.selectOptions=[],null!==n.field.widget.relationship_add_url&&(n.selectOptions=f(n.selectOptions,0===e.data.results.length))})}}n.refreshField=d,n.trustAsHtml=e.trustAsHtml,n.selectOptions=[],a()}}}).directive("uiSelectRelationship",function(e){return{restrict:"A",require:"uiSelect",link:function(e,t,i,n){function l(t,i){if(!angular.equals(t.text,t.id)&&null!==t.id&&e.field.widget.relationship_add_url){var n=$("<form method='post'><input name='object' /><input name='go_to_detail' /></form>");n.attr("action",e.field.widget.relationship_add_url),n.append($("input[name=csrfmiddlewaretoken]").clone()),n.find("input[name=object]").val(i),n.appendTo("body"),n.submit()}}e.choiceSelected=l}}}),angular.module("axis.fields.helpers.multiSelect").directive("multiSelectHelper",function(){return{restrict:"A",link:function(e,t,i){function n(){r(l())}function l(){return e.field.value||(e.field.value=e.regionObject.object[e.field.field_name]),e.field.value?_.object(u(e.field.value)):{}}function r(t){var i=[];e.field.widget.choices&&e.field.widget.choices.length&&angular.forEach(e.field.widget.choices,function(e,n,l){""===e[0]&&(e[0]=null);var r=f(e[0],e[1],e[0]in t);i.push(r)}),e.selectOptions=i}function o(){var t=[];angular.forEach(e.tempOutputList,function(e){t.push(e.id)}),e.regionObject.object[e.field.field_name]=t}function a(){e.regionObject.object[e.field.field_name]=e.tempOutputList.length?e.tempOutputList[0].id:null}function c(t,i){_.forEach(e.selectOptions,function(e){e.selected=e.id==t})}function u(e){return angular.isArray(e)?e:[e]}function s(t){return!!e.regionObject.helpers.locked_company_ids&&e.regionObject.helpers.locked_company_ids.indexOf(t)>-1}function f(e,t,i){var n=s(e);return n&&(t='<i class="fa fa-lock"></i> '+t),{id:e,text:t,selected:i,checkboxDisabled:n}}e.selectOptions=[],e.tempOutputList=[],n(),e.$watch("tempOutputList",i.selectionMode&&"single"==i.selectionMode?callWhenDifferent(a):callWhenDifferent(o)),e.$watchCollection("field.widget.choices",callWhenDifferent(function(){r(l())})),i.selectionMode&&"single"==i.selectionMode&&e.$watch(function(){return e.regionObject.object[e.field.field_name]},callWhenDifferent(c))}}}).directive("duallistHelper",function(){return{restrict:"A",link:function(e,t,i){function n(){r(l())}function l(){return e.field.value||(e.field.value=e.regionObject.object[e.field.field_name]),e.field.value?_.object(a(e.field.value)):{}}function r(t){var i=[];e.field.widget.choices&&e.field.widget.choices.length&&angular.forEach(e.field.widget.choices,function(n,l,r){""===n[0]&&(n[0]=null);var o=u(n[0],n[1]);n[0]in t?e.tempOutputList.push(o):i.push(o)}),e.selectOptions=i}function o(){var t=[];angular.forEach(e.tempOutputList,function(e){t.push(e.id)}),e.regionObject.object[e.field.field_name]=t}function a(e){return angular.isArray(e)?e:[e]}function c(t){return!!e.regionObject.helpers.locked_company_ids&&e.regionObject.helpers.locked_company_ids.indexOf(t)>-1}function u(e,t){var i=c(e);return i&&(t='<i class="fa fa-lock"></i> '+t),{id:e,text:t}}e.$watch(function(){return e.field},function(){n()}),e.selectOptions=[],e.tempOutputList=[],e.$watch("tempOutputList",callWhenDifferent(o),!0)}}}),angular.module("axis.fields.helpers.datepicker").directive("datepickerHelper",function(){return{restrict:"A",controller:function(e){e.opened=!1,e.format="MM/dd/yyyy",e.open=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0},e.date=e.regionObject.object[e.field.field_name],e.$watch("date",function(t,i){if(t!==i){var n;try{var l=[t.getFullYear().toString(),(t.getMonth()+1).toString(),t.getDate().toString()];n=l.join("-")}catch(e){n=t}e.regionObject.object[e.field.field_name]=n}})}}}),angular.module("axis.fields.helpers").directive("nonNegativeNumber",function(){return buildRegexDirective(/[^\d.]/g)}).directive("nonNegativeWholeNumber",function(){return buildRegexDirective(/[^\d]/g)});
