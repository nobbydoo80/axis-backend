var FEATURES={certification:{active:!0},qa:{active:!!window._qa_active||!1,addNote:!0},notes:{active:!0},projecttracker:{active:!0}};$(function(){var t,e="certification",n={certification:Certification(),qa:QA(),notes:HomeNotes(),projecttracker:ProjectTracker()},r={icons:{spinner:(t="fa-spin fa-spinner",$("<i>").addClass("fa fa-fw").addClass(t))}},a=$(".datatable"),o=$("#result-modal"),i=$("#transaction-modal"),s=$("button[data-toggle='tab']"),c=$("#mode");function l(){a.find(".datatable :checkbox:checked").prop("checked",!1),$(".no-items-selected").toggle(!0),$(".items-selected").toggle(!1)}function u(){var t=a.find("tbody :checkbox:checked").length,e=t>0;$(".no-items-selected").toggle(!e),$(".items-selected").toggle(e),$(".checked-item-counter").text(t)}function d(){return FEATURES[e].active}function p(){return n[e]}a.on("change","tbody :checkbox",function(t){var e=p();if(d()&&e.hasOwnProperty("checkboxHandler")){var n=e.checkboxHandler.call(this,t);void 0!==n?n.then(function(){u()}):u()}else u()}),s.on("click",function(t){try{e=t.target.innerText.toLowerCase()}catch(n){e=t.target.textContent.toLowerCase()}var n=p();c.val(e),n.hasOwnProperty("tabChangeHandler")&&n.tabChangeHandler.call(this,t);l()}),o.on("show.bs.modal",function(t){var e=$(t.relatedTarget||t.target),n=$(this),r=e.data("transaction");n.find(".modal-title").html(r.title),n.find(".modal-body").html(new Transaction(r))}),i.on("show.bs.modal",function(t){if($(t.target).hasClass("dateinput"))return;var e=a.find("tbody :checkbox:checked");if(!e.length)return t.preventDefault(),void alert("Please select some homes.");var n=p(),o=_.clone(p().transactionObj,!0),i=$(this),s=(c=i.find(".modal-body .target"),u=o,function(){c.html(new Transaction(u))});var c,u;e.each(function(t,e){return function(){var n=$(this),r=n.closest("tr").attr("id"),a=n.parent().siblings().first().html(),o=$(n.parent().siblings().get(2)).html(),i=_.findWhere(t.programs,{name:o});if(!i){i={name:o,homes:[]},t.programs.push(i);var s="/api/v2"+$(o).attr("href")+"note/";$.ajax({url:s,cache:!0,success:function(t){t.length>1&&(i.footer=t,e())}})}var c={id:r,name:a,result:null,data:null,el:n};t.homes.push(c),i.homes.push(c)}}(o,s)),s(),i.find(".modal-title").html(o.title),i.find(".primary-action").html(o.button),n.showModal(i);var f=function(t,e,n,o,i){return function(){if(d()&&(!t.hasOwnProperty("canContinue")||t.canContinue(n))){$(this).attr("disabled",!0),$(this).prepend(r.icons.spinner.clone());var s=_.after(o.length,function(){a.dataTable().fnDraw(),e.complete=!0,n.find(".form-group").remove(),n.find(".fa-spinner").remove(),$(".quick-link .badge").html(r.icons.spinner.clone()),$.ajax({method:"GET",url:"/api/v2/quick_links/",data:{view:"provider_dashboard"},success:function(t){_.each(t,function(t){var e=$("#quick_link_"+t.slug);e.find(".badge").html(t.count),_.each(t.filters,function(t){e.find('.filter[data-name="'+t.name+'"]').attr("data-value",t.value)})})},error:function(t){console.log(t)}})}),c=new AsyncProgressBar(o.length,".progress-bar-target");c.container.find(".progress").attr("data-target","#result-modal").attr("data-toggle","modal").data("transaction",e).addClass(e.type+"-results"),t.modifyTransaction(e,n);var u=t.getItemHandler(e,s,i,c);e.homes.reduce(function(t,e){return t.then(function(){var t=u(e);return t instanceof Promise||(t=Promise.resolve(t)),t})},Promise.resolve()),l()}}}(n,o,i,e,s);i.find(".primary-action").on("click",f)}),i.on("hide.bs.modal",function(t){if($(t.target).hasClass("dateinput"))return;var e=p(),n=$(this);n.find(".primary-action").attr("disabled",!1).off("click"),e.hideModal(n)});var f=$(".list-group.snapshot");$("#toggle-snapshot").on("click",function(t){t.preventDefault();var e=$(this);"Show Stats"==e.text()?(f.slideDown(),e.text("Hide Stats")):(f.slideUp(),e.text("Show Stats"))}),f.on("click",".list-group-item",function(t){t.preventDefault(),$("#query_form").find("input:visible, select:visible, #id_exclude_ids").val(""),$(".select2-container select").val("").trigger("change");let e=$(this).attr("id");"quick_link_qa-correction-required"===e||"quick_link_qa-correction-received"===e?$("#id_state").val(""):$('#id_state option[value="certification_pending"]').prop("selected",!0),$(this).find(".filter").each(function(t){var e=$(this),n=e.attr("data-name"),r=e.attr("data-value"),a=$("#id_"+n);0==a.length&&(a=$("#id_"+n.replace("_id",""))),a.hasClass("select2multiplewidget")?(r.indexOf("[")>-1&&(r=JSON.parse(r)),a.select2("val",r)):a.val(r)}),$("#query_form").trigger("change"),$("form").one("change",function(){f.find(".active").removeClass("active")}),$(this).addClass("active")}),$("#clear-filters").on("click",function(t){t.preventDefault(),$("a.list-group-item").removeClass("active"),$("#query_form").find("input:visible, select:visible").val(""),$(".select2-container").select2("val",""),$('#id_state option[value="certification_pending"]').prop("selected",!0),a.dataTable().fnDraw()})});var CheckBox=function(){var t=$("<div>").addClass("checkbox form-group"),e=$("<label>"),n=$("<input type='checkbox'/>").attr("checked","checked");function r(t){return this.options=t,this.render(),this.el}return r.prototype.render=function(){var r=e.clone().append(n.clone(),this.getText());this.el=t.clone().append(r)},r.prototype.getText=function(){return"Is public"},r}(),TextArea=function(){var t=$("<textarea>").addClass("form-control").attr("placeholder","Note...");function e(t){return this.options=t,this.render(),this.el}function n(t,e){return e=e?"<"+e+">":"<div>",$(e).addClass(t)}return e.prototype.render=function(){var e=n("form-group"),r=n("control-label","label").text(this.options.label),a=n("controls"),o=t.clone();this.el=e.append(r,a.append(o))},e}(),DatePickerInput=function(){var t=s("form-group"),e=s("control-label","label").text("Certification Date"),n=s("controls"),r=s("input-group date"),a=s("input-group-addon").append(s("fa fa-calendar","i")),o=$("<input type='text' />").addClass("dateinput form-control").attr("placeholder","Certification Date...").attr("data-provide","datepicker").attr("data-date-format","m/d/yyyy").attr("data-date-today-btn",!1).attr("data-date-autoclose",!0).val(moment().format("M/D/YYYY"));function i(t){return this.options=t,this.render(),this.el}function s(t,e){return e=e?"<"+e+">":"<div>",$(e).addClass(t)}return i.prototype.render=function(){this.el=s("row").append(s("col-md-6").append(t.clone().append(this.getLabel(),this.getInput())))},i.prototype.getLabel=function(){return e.clone()},i.prototype.getInput=function(){return n.clone().append(r.clone().append(o.clone(),a.clone()))},i}(),Transaction=function(){var t=$("<div>");function e(t){return this.options=t,this.render(),this.el}return e.prototype.render=function(){this.el=t.clone(),this.el.append(this.getPrograms()),this.options.hasOwnProperty("extraText")&&this.el.append(this.getExtraText())},e.prototype.getPrograms=function(){return this.options.programs.map(function(t){return new Program(t)})},e.prototype.getExtraText=function(){if(this.options.complete)return this.options.extraText()},e}(),Program=function(){var t={wrapper:n("panel panel-default"),heading:n("panel-heading"),title:n("panel-title","h5"),body:n("list-group","ul"),footer:n("panel-footer")};function e(t){return this.options=t,this.render(),this.el}function n(t,e){return e=e?"<"+e+">":"<div>",$(e).addClass(t)}return e.prototype.render=function(){this.el=t.wrapper.clone(),this.el.append(this.getHeader()),this.el.append(this.getHomes()),this.el.append(this.getFooter())},e.prototype.getHeader=function(){return t.heading.clone().html(t.title.clone().html(this.options.name))},e.prototype.getHomes=function(){var e=this.options.homes.map(function(t){return new Home(t)});return t.body.clone().html(e)},e.prototype.getFooter=function(){if(this.options.footer)return t.footer.clone().html(this.options.footer)},e}(),Home=function(){var t=$("<li>").addClass("list-group-item"),e=$("<h5>").addClass("list-goup-item-heading"),n=$("<p>").addClass("list-group-item-text");function r(t){return this.options=t,this.render(),this.el}return r.prototype.render=function(){this.el=t.clone(),this.el.attr("data-id",this.options.id),this.el.html(this.getText()),this.el.addClass(this.getClass())},r.prototype.getText=function(){return[this.getHeading(),this.getBody()]},r.prototype.getClass=function(){var t=this.options.result;return"success"==t?"list-group-item-success":"error"==t?"list-group-item-danger":""},r.prototype.getHeading=function(){return e.clone().html(this.options.name)},r.prototype.getBody=function(){return n.clone().html(this.options.data||"Pending...")},r}(),Certification=function(){$(".datatable");var t,e=angular.element($("[ng-app]")).injector().get("MessagingService"),n={icons:{spinner:(t="fa-spin fa-spinner",$("<i>").addClass("fa fa-fw").addClass(t))},cannotCertify:$("<span>Cannot be Certified. <span class='popover-target btn btn-xs btn-default'>Why Not?</span></span>")},r={certify:function(t){return"/api/v2/homestatus/"+t+"/certify/"},check:function(t){return"/api/v2/homestatus/"+t+"/can_certify/"}},a={html:!0,level:"error",title:"Error",content:null};return{showModal:function(t){var e=new DatePickerInput;t.find(".modal-body").append(e)},hideModal:function(t){t.find(".form-group").remove()},canContinue:function(t){if(!t.find(".dateinput").val())return alert("Please select a Certification Date."),!1;return!0},modifyTransaction:function(t,e){t.certificationDate=e.find(".dateinput").val()},getItemHandler:function(t,e,n,a){return function(o){var i=function(t,e){return{success:function(n){var n=n.data;e.success(),t.result="success",t.data=0==n.length?"Successfully Certified":n},error:function(n){e.error(),t.result="error",t.data=n.responseText}}}(o,a);return $.ajax({url:r.certify(o.id),data:{bypass_check:!0,certification_date:t.certificationDate},success:i.success,error:i.error,complete:function(){e(),n()}})}},checkboxHandler:function(){if(!this.checked||$(this).find(".fa-spinner").length>0)return;var t=$(this),o=t.parent(),i=t.closest("tr"),s=i.attr("id"),c=n.icons.spinner.clone();return t.hide(),o.append(c),$.ajax({url:r.check(s),success:function(){t.show()},error:function(t){var r=n.cannotCertify.clone();i.addClass("warning"),o.html(r),a.content=t.responseJSON.join("<br/>"),r.find(".popover-target").popover(a),e.introduceExternalMessage(a)},complete:function(){c.remove()}})},tabChangeHandler:function(){$("#id_state").val("certification_pending").trigger("change").removeAttr("disabled"),$("#id_qastatus").val("").trigger("change")},transactionObj:{programs:[],homes:[],complete:!1,certificationDate:null,title:"Certification",button:"Certify",type:"certification",extraText:function(){return"Certification Date: "+this.certificationDate}}}},QA=function(){$(".datatable");var t={add:function(t){return"/api/v2/homestatus/"+t+"/add_program_review_qa/"}};return{showModal:function(t){if(FEATURES.qa.addNote){var e=new TextArea({label:"QA Note"});t.find(".modal-body").append(e)}},hideModal:function(t){t.find(".form-group").remove()},modifyTransaction:function(t,e){FEATURES.qa.addNote&&(t.note=e.find("textarea").val())},getItemHandler:function(e,n,r,a){return function(o){var i=function(t,e){return{success:function(n){e.success(),t.result="success",t.data=n.message},error:function(n){e.error(),t.result="error",t.data=n.responseText}}}(o,a),s={url:t.add(o.id),success:i.success,error:i.error,complete:function(){n(),r()}};FEATURES.qa.addNote&&(s.data={note:e.note}),$.ajax(s)}},tabChangeHandler:function(t){$("#id_state").removeAttr("disabled"),$("#id_state").val(""),$("#id_qastatus").val(-1).trigger("change")},transactionObj:{programs:[],homes:[],complete:!1,note:null,title:"Program Review",button:"Add Review",type:"qa",extraText:function(){return this.note?"Note: "+this.note:""}}}},HomeNotes=function(){$(".datatable");var t={add:"/api/v2/eepprogramhomestatus/annotations/"};return{showModal:function(t){var e=new TextArea({label:"Home Note"}),n=new CheckBox;t.find(".modal-body").append($("<hr/>"),n,e)},hideModal:function(t){t.find(".form-group, hr").remove()},canContinue:function(t){if(!t.find("textarea").val())return alert("Must provide a note."),!1;return!0},tabChangeHandler:function(){$("#id_state").removeAttr("disabled")},modifyTransaction:function(t,e){t.note=e.find("textarea").val(),t.is_public=e.find(":checkbox").is(":checked")},getItemHandler:function(e,n,r,a){return function(o){var i=function(t,e){return{success:function(n){e.success(),t.result="success",t.data="Note Added"},error:function(n){e.error(),t.result="error",t.data=n}}}(o,a);$.ajax({url:t.add+"?machinery=EEPProgramHomeStatusAnnotationsMachinery_note",method:"POST",data:{content:e.note,is_public:e.is_public,object_id:o.id,type:"note"},success:i.success,error:i.error,complete:function(){n(),r()}})}},transactionObj:{programs:[],homes:[],complete:!1,note:null,title:"Home Notes",button:"Add Note",type:"notes",extraText:function(){return"Note: "+this.note}}}},ProjectTracker=function(){$(".datatable");MessagingService=angular.element($("[ng-app]")).injector().get("MessagingService");var t,e={icons:{spinner:(t="fa-spin fa-spinner",$("<i>").addClass("fa fa-fw").addClass(t))},cannotSubmit:$("<span>Cannot be submitted. <span class='popover-target btn btn-xs btn-default'>Why Not?</span></span>")},n={taskSubmit:function(t){return"/home/"+t+"/xml/task/"},taskStatus:function(t,e){return"/home/"+t+"/xml/task/"+e+"/"}},r={requesting:"Acknowledging...",waiting:"Waiting...",processing:"Submitting...",complete:"Finishing..."},a={html:!0,level:"error",title:"Error",content:null};return{showModal:function(t){},hideModal:function(t){t.find(".form-group, hr").remove()},canContinue:function(t){return!0},modifyTransaction:function(t,e){},getItemHandler:function(t,e,a,o){return function(t){var i=function(t,e){function n(t){if(!t)return"";var e=parseInt(""+t/1e3/60),n=_.padLeft(parseInt(""+t/1e3%60),2,"0");return" (~"+e+":"+n+")"}return{success:function(r,a){e.success(t),t.result="success",t.data="Submitted"+n(a)},update:function(e,a){t.data=r[e.status]+n(a)},error:function(r,a){var o=r.responseText;e.error(),t.result="error",void 0!==r.error&&void 0!==(o=r.error).exc_message&&(o=o.exc_message),t.data="Error"+n(a)+": "+o}}}(t,o);return new Promise(function(o){$.ajax({url:n.taskSubmit(t.id),method:"POST",success:function(s){!async function(o,s){function c(t){return new Promise(function(e){setTimeout(e,t)})}function l(t){"processing"==t.status&&null===u&&(u=new Date),null!==u&&(d=new Date-u),"complete"==t.status?i.success(t,d):"error"==t.status?i.error(t,d):i.update(t,d),a()}var u=null,d=null;t.result="pending",t.data=r.requesting,a();for(;"pending"==t.result;)await c(2e3),$.ajax({async:!1,url:n.taskStatus(t.id,o),method:"GET",success:l,error:l});e(),s()}(s.id,o)},error:function(t){i.error(t),e(),a(),o()}})})}},checkboxHandler:function(){if(!this.checked)return;var t=$(this),n=t.parent(),r=t.closest("tr"),o=(r.attr("id"),e.icons.spinner.clone());if(t.hide(),n.append(o),n.closest("table").DataTable().row(r).data().DT_RowData.projecttracker_submit_available)t.show();else{var i=e.cannotSubmit.clone();r.addClass("warning"),n.html(i),a.content="This home is not ready for submission or has been submitted already.",i.find(".popover-target").popover(a),MessagingService.introduceExternalMessage(a)}o.remove()},tabChangeHandler:function(){$("#id_state").val("complete").trigger("change").attr("disabled","disabled")},transactionObj:{programs:[],homes:[],complete:!1,title:"Submit to ProjectTracker",button:"Submit",type:"projecttracker",extraText:function(){return""}}}};